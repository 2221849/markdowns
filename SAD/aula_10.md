# Decision Support Systems

## Lesson 10

### `LOAD_DIM_PRODUCT`

```sql
PROCEDURE LOAD_DIM_PRODUCT IS CURSOR PRODUCTS_CURSOR IS
SELECT
  ID,
  NAME,
  BRAND,
  NVL(PACK_SIZE, -1) AS PACK_SIZE,
  NVL(PACK_TYPE, -1) AS PACK_TYPE,
  DIET_TYPE,
  NVL(LIQ_WEIGHT, -1) AS LIQ_WEIGHT,
  CATEGORY_NAME
FROM
  T_CLEAN_PRODUCTS;

-- COUNTERS
I INTEGER := 0;

V_NEW_PRODUCTS INTEGER := 0;

V_NEW_VERSIONS INTEGER := 0;

V_OLD_VERSIONS INTEGER := 0;

-- VARIABLES FOR SCD CHECKING
V_PRODUCT_KEY T_DIM_PRODUCT.PRODUCT_KEY % TYPE;

V_SIZE_PACKAGE T_DIM_PRODUCT.PRODUCT_SIZE_PACKAGE % TYPE;

V_TYPE_PACKAGE T_DIM_PRODUCT.PRODUCT_TYPE_PACKAGE % TYPE;

V_DIET_TYPE T_DIM_PRODUCT.PRODUCT_DIET_TYPE % TYPE;

V_LIQUID_WEIGHT T_DIM_PRODUCT.PRODUCT_LIQUID_WEIGHT % TYPE;

BEGIN
  PCK_LOG.WRITE_LOG('  LOADING DATA ["LOAD_DIM_PRODUCT"]');

PCK_LOG.ROWCOUNT('T_DIM_PRODUCT', 'BEFORE');

FOR REC IN PRODUCTS_CURSOR
LOOP
  -- SEARCH THE PRODUCT IN THE DIMENSION BY SELECTING SCD2 ATTRIBUTES
  BEGIN
    SELECT
      PRODUCT_KEY,
      NVL(PRODUCT_SIZE_PACKAGE, -1),
      NVL(PRODUCT_TYPE_PACKAGE, -1),
      PRODUCT_DIET_TYPE,
      NVL(PRODUCT_LIQUID_WEIGHT, -1) INTO V_PRODUCT_KEY,
      V_SIZE_PACKAGE,
      V_TYPE_PACKAGE,
      V_DIET_TYPE,
      V_LIQUID_WEIGHT
    FROM
      T_DIM_PRODUCT
    WHERE
      PRODUCT_NATURAL_KEY = REC.ID
      AND IS_EXPIRED_VERSION = 'NO';

-- IF A RECORD WAS FOUND, THEN THE SOURCE PRODUCT IS IN FACT A NEW VERSION:
-- DID ANY OF THE SCD2 ATTRIBUTES CHANGE?
IF (REC.PACK_SIZE != V_SIZE_PACKAGE)
OR (REC.PACK_TYPE != V_TYPE_PACKAGE)
OR (REC.DIET_TYPE != V_DIET_TYPE)
OR (REC.LIQ_WEIGHT != V_LIQUID_WEIGHT) THEN
UPDATE
  T_DIM_PRODUCT
SET
  IS_EXPIRED_VERSION = 'YES'
WHERE
  PRODUCT_KEY = V_PRODUCT_KEY;

INSERT INTO
  T_DIM_PRODUCT (
    PRODUCT_KEY,
    PRODUCT_NATURAL_KEY,
    PRODUCT_NAME,
    PRODUCT_BRAND,
    PRODUCT_CATEGORY,
    PRODUCT_SIZE_PACKAGE,
    PRODUCT_TYPE_PACKAGE,
    PRODUCT_DIET_TYPE,
    PRODUCT_LIQUID_WEIGHT,
    IS_EXPIRED_VERSION
  )
VALUES
  (
    SEQ_DIM_PRODUCT.NEXTVAL,
    REC.ID,
    REC.NAME,
    REC.BRAND,
    REC.CATEGORY_NAME,
    REC.PACK_SIZE,
    REC.PACK_TYPE,
    REC.DIET_TYPE,
    REC.LIQ_WEIGHT,
    'NO'
  );

V_NEW_PRODUCTS := V_NEW_PRODUCTS + 1;

ELSE
UPDATE
  T_DIM_PRODUCT
SET
  PRODUCT_NAME = REC.NAME,
  PRODUCT_BRAND = REC.BRAND,
  PRODUCT_CATEGORY = REC.CATEGORY_NAME
WHERE
  PRODUCT_KEY = V_PRODUCT_KEY;

V_OLD_VERSIONS := V_OLD_VERSIONS + 1;

END IF;

EXCEPTION
  WHEN NO_DATA_FOUND THEN -- IF NOT FOUND, THEN ITS A NEW PRODUCT
INSERT INTO
  T_DIM_PRODUCT (
    PRODUCT_KEY,
    PRODUCT_NATURAL_KEY,
    PRODUCT_NAME,
    PRODUCT_BRAND,
    PRODUCT_CATEGORY,
    PRODUCT_SIZE_PACKAGE,
    PRODUCT_TYPE_PACKAGE,
    PRODUCT_DIET_TYPE,
    PRODUCT_LIQUID_WEIGHT,
    IS_EXPIRED_VERSION
  )
VALUES
  (
    SEQ_DIM_PRODUCT.NEXTVAL,
    REC.ID,
    REC.NAME,
    REC.BRAND,
    REC.CATEGORY_NAME,
    REC.PACK_SIZE,
    REC.PACK_TYPE,
    REC.DIET_TYPE,
    REC.LIQ_WEIGHT,
    'NO'
  );

V_NEW_PRODUCTS := V_NEW_PRODUCTS + 1;

END;

END
LOOP
;
```

### `LOAD_DIM_DATE`

```sql
-- UPDATE THE TEMPERATURE STATUS.
UPDATE
  T_DIM_DATE
SET
  DATE_TEMPERATURE_DATE = (
    SELECT
      TEMPERATURE_STATUS
    FROM
      T_CLEAN_CELSIUS
    WHERE
      FORECAST_DATE = L_TODAY
  )
WHERE
  DATE_FULL_DATE = L_TODAY;
```

### START OF `LOAD_FACT_TABLE`

```sql
SELECT
--  V_STORE_KEY AS STORE_KEY,
--  V_CUSTOMER_KEY AS CUSTOMER_KEY,
  PROD.PRODUCT_KEY,
  LS.SALE_ID AS SALE_ID_DD,
  LS.QUANTITY AS SOLD_QUANTITY,
  LS.AMMOUNT_PAID,
  T.TIME_KEY,
  D.DATE_KEY,
  PROMO.PROMO_KEY
FROM
  T_CLEAN_LINESOFSALE LS
  JOIN T_DIM_PRODUCT PROD ON LS.PRODUCT_ID = PROD.PRODUCT_NATURAL_KEY
  JOIN T_DIM_TIME T ON TO_CHAR(LS.LINE_DATE,'HH24:MI:SS') = T.TIME_FULL_TIME
  JOIN T_DIM_DATE D ON TO_CHAR(LS.LINE_DATE,'DD/MM/YYYY') = D.DATE_FULL_DATE
  JOIN T_DIM_PROMOTION PROMO ON PROMO_ID = PROMO_NATURAL_KEY
WHERE IS_EXPIRED_VERSION = 'NO';
```
